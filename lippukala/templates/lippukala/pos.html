<!doctype html>
<html lang="fi">
  <head>
    <title>POS</title>
    <script type="text/javascript">
      /**
       * @typedef {Object} Code
       * @property {number} id
       * @property {boolean} used
       * @property {string} code
       * @property {string} prefix
       * @property {string} lit
       * @property {string} [name]
       * @property {string} comment
       * @property {string} prod
       * @property {boolean} [localUsed]
       */

      /**
       * @typedef {Object} CodesResponse
       * @property {Code[]} codes
       */

      let codeInput;
      let statusDiv;

      /** @type {Record<number, Code>} */
      const codes = {};

      /** @type {number[]} */
      let useQueue = [];

      /** @type {number|null} */
      let currentlyShownId = null;

      /**
       * @param {CodesResponse} data
       */
      function parseData(data) {
        for (const code of data.codes) {
          codes[code.id] = { ...(codes[code.id] || {}), ...code };
        }
        console.log(`Got ${data.codes.length} codes`);
      }

      async function download() {
        const jsonUrl = `?json=1&t=${Math.round(+new Date())}`;
        const response = await fetch(jsonUrl);
        if (!response.ok) throw new Error(`Failed to fetch ${jsonUrl}`);
        const data = await response.json();
        parseData(data);
      }

      function escapeHtml(str) {
        const div = document.createElement("div");
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
      }

      function Tee(template, env) {
        return template.replace(/\{(.+?)\}/g, (_, m) => escapeHtml(env[m] || "").replace(/\n/g, "<br>"));
      }

      /**
       * @param {Code} code
       */
      function showCode(code) {
        currentlyShownId = code.id;
        statusDiv.innerHTML = Tee(
          "<div class=cd><span class=pfx>{prefix}</span>{code}</div>{lit}<div class=product>{prod}</div><div class=addr>{name}</div><div class=comment>{comment}</div>",
          code,
        );
        let cls = "code-unused";
        if (code.used) cls = "code-used";
        else if (code.localUsed) cls = "code-localused";
        document.body.className = cls;
      }

      /**
       * @param {Code} code
       */
      function useCode(code) {
        code.localUsed = true;
        useQueue.push(code.id);
        showCode(code);
      }

      /**
       * @param {Code} code
       */
      function confirmUseCode(code) {
        if (code.used || code.localUsed) {
          alert("Koodi näyttää jo käytetyltä!\nOta yhteys tapahtuman taloustiimiin asian selvittämiseksi.");
          return;
        } // eslint-disable-next-line no-restricted-globals
        if (!confirm(`Käytä koodi ${code.code}?`)) {
          return;
        }
        useCode(code);
        setTimeout(syncUseQueue, 4);
        setTimeout(() => {
          codeInput.value = "";
          codeInput.focus();
        }, 250);
      }

      function search(enter) {
        let nStarting = 0;
        const inputCode = codeInput.value.toLowerCase();
        let regexpText = `^${inputCode}`;
        if (/^[-a-z]+ /i.test(inputCode)) {
          // Cheap "fuzzy" searching ("d bu" will match "desu butler")
          regexpText = `^${inputCode
            .split(/\s+/)
            .filter((word) => word.length > 0)
            .join("[^ ]*? ")}`;
          regexpText = regexpText.replace(/\s+$/, "");
        }
        const searchRegexp = new RegExp(regexpText, "i");
        let lastCode = null;
        document.body.className = "";
        for (const code of Object.values(codes)) {
          const prefixedCode = (code.prefix || "") + code.code;
          if (
            inputCode === code.code ||
            inputCode === prefixedCode ||
            inputCode === code.lit.toLowerCase() ||
            searchRegexp.test(code.code) ||
            searchRegexp.test(prefixedCode) ||
            searchRegexp.test(code.lit)
          ) {
            nStarting++;
            lastCode = code;
          }
        }
        if (nStarting === 1) {
          showCode(lastCode);
          if (enter) confirmUseCode(lastCode);
        } else if (nStarting === 0) {
          statusDiv.innerHTML = "Koodilla ei löydy yhtään lippua. Ole hyvä ja tarkista oikeinkirjoitus ja tapahtuma!";
        } else {
          statusDiv.innerHTML = `... ${nStarting} ...`;
        }
      }

      function keyPress() {
        search(false);
      }

      function formSubmit(event) {
        event.preventDefault();
        search(true);
      }

      async function syncUseQueue() {
        useQueue = useQueue.filter((id) => codes[id].localUsed && !codes[id].used);
        if (!useQueue.length) {
          return;
        }
        const formData = new FormData();
        formData.append("use", useQueue.join(","));
        // eslint-disable-next-line no-restricted-globals
        const resp = await fetch(location.href, {
          method: "POST",
          body: formData,
        });
        if (!resp.ok) throw new Error(`Failed to sync use queue`);
        const data = await resp.json();
        console.log(`successfully synced ${useQueue.length} code uses`);
        parseData(data);
        if (currentlyShownId) showCode(codes[currentlyShownId]);
      }

      function debounce(fn, delay) {
        let timer = null;
        return function () {
          const clear = function () {
            timer = null;
          };
          if (timer === null) {
            fn.apply(this, arguments); // eslint-disable-line prefer-rest-params
          } else {
            arguments[0].preventDefault(); // eslint-disable-line prefer-rest-params
          }
          window.clearTimeout(timer);
          timer = window.setTimeout(clear, delay);
        };
      }

      window.init = async function init() {
        await download();
        setInterval(download, (50 + Math.random() * 20) * 1000);
        setInterval(syncUseQueue, 5000);

        codeInput = document.getElementById("code");
        statusDiv = document.getElementById("status");
        codeInput.addEventListener("input", keyPress, true);
        document.getElementById("codeform").addEventListener("submit", debounce(formSubmit, 250), true);
      };
    </script>
    <style>
      body,
      input {
        font:
          36pt/1.2 Arial,
          sans-serif;
        -webkit-transition: background 0.5s;
      }

      body.code-unused {
        background: #00c300;
      }

      body.code-localused {
        background: #f95;
      }

      body.code-used {
        background: #e51e1f;
        color: yellow;
      }

      .cd {
        font-family: consolas, monospace;
        background: #000;
        color: #fff;
        font-size: 48pt;
        padding: 12pt;
      }

      .pfx {
        opacity: 0.6;
      }

      .product {
        margin: 0.5em;
        padding: 0.5em;
        background: #333;
        color: #fff;
        border: 0.2em solid #000;
      }

      form {
        margin: auto;
        text-align: center;
      }

      #code {
        width: 100%;
      }
    </style>
  </head>
  <body onload="init()">
    <form id="codeform">
      <input placeholder="koodi tähän" type="text" id="code" autofocus autocomplete="no" /><br />
      <div id="status">&nbsp;</div>
    </form>
  </body>
</html>
